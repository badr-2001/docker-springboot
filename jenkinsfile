pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        GITHUB_CREDENTIALS = 'github-crd'
    }

    stages {
        stage('Clean workspace and pull latest') {
            steps {
                deleteDir()
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/k8s']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/badr-2001/docker-springboot.git',
                        credentialsId: "${env.GITHUB_CREDENTIALS}"
                    ]]
                ])
            }
        }

        stage('Build with Maven') {
            steps {
                echo 'Running Maven build...'
                sh 'mvn clean compile'
            }
        }

        stage('Run Tests') {
            steps {
                echo 'Running Maven tests...'
                sh 'mvn test'
            }
        }

        stage('Debug: Show Dockerfile') {
            steps {
                sh 'cat Dockerfile'
            }
        }

        stage('Build Docker Images') {
            steps {
                echo "Building DOCKER IMAGES .............."
                sh 'docker build -f dockerfile-front -t badr200199/front_demo .'
                sh 'docker build --no-cache -t badr200199/backend .'
                sh 'docker build -f dockerfile-postgress -t badr200199/db .'
            }
        }

        stage("Check if Docker Images are there") {
            steps {
                sh 'docker images'
            }
        }
    }
}
